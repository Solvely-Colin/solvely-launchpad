# Reusable CI workflow ‚Äî zero-config with auto-detection, fully overridable
# Usage: uses: Solvely-Colin/solvely-launchpad/.github/workflows/ci.yml@v1

name: CI

on:
  workflow_call:
    inputs:
      node-versions:
        description: 'JSON array of Node versions for test matrix (auto-detected from .nvmrc)'
        type: string
        default: ''
      has-typescript:
        description: 'Run typecheck (auto-detected from tsconfig.json)'
        type: string
        default: ''
      has-eslint:
        description: 'Run lint (auto-detected from eslint config)'
        type: string
        default: ''
      has-prettier:
        description: 'Run format:check (auto-detected from prettier config)'
        type: string
        default: ''
      has-build:
        description: 'Run build step (auto-detected from package.json scripts)'
        type: string
        default: ''
      build-command:
        description: 'Custom build command (auto-detected)'
        type: string
        default: ''
      test-command:
        description: 'Custom test command (auto-detected)'
        type: string
        default: ''
      install-command:
        description: 'Custom install command (auto-detected)'
        type: string
        default: ''
      lint-command:
        description: 'Custom lint command (auto-detected)'
        type: string
        default: ''
      format-command:
        description: 'Custom format check command (auto-detected)'
        type: string
        default: ''
      typecheck-command:
        description: 'Custom typecheck command (auto-detected)'
        type: string
        default: ''
      bundle-size:
        description: 'Run size-limit check (auto-detected from .size-limit.json)'
        type: string
        default: ''
      license-check:
        description: 'Run license checker (default: true)'
        type: string
        default: ''
      security-audit:
        description: 'Run npm audit (default: true)'
        type: string
        default: ''
      audit-level:
        description: 'npm audit level'
        type: string
        default: ''
      package-manager:
        description: 'Force package manager (npm, pnpm, yarn). Empty = auto-detect'
        type: string
        default: ''
      gate-codeql:
        description: 'Enable CodeQL quality gate (opt-in)'
        type: boolean
        default: false
      gate-dependency-review:
        description: 'Enable dependency review quality gate (opt-in)'
        type: boolean
        default: false
      gate-sbom:
        description: 'Enable SBOM quality gate (opt-in)'
        type: boolean
        default: false
      gate-slsa-provenance:
        description: 'Enable SLSA provenance quality gate (opt-in)'
        type: boolean
        default: false
      gate-ossf-scorecard:
        description: 'Enable OSSF Scorecard quality gate (opt-in)'
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Auto-detect project
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      node-versions: ${{ steps.detect.outputs['node-versions'] }}
      has-typescript: ${{ steps.detect.outputs['has-typescript'] }}
      has-eslint: ${{ steps.detect.outputs['has-eslint'] }}
      has-prettier: ${{ steps.detect.outputs['has-prettier'] }}
      has-build: ${{ steps.detect.outputs['has-build'] }}
      has-test: ${{ steps.detect.outputs['has-test'] }}
      has-size-limit: ${{ steps.detect.outputs['has-size-limit'] }}
      is-monorepo: ${{ steps.detect.outputs['is-monorepo'] }}
      package-manager: ${{ steps.detect.outputs['package-manager'] }}
      build-command: ${{ steps.detect.outputs['build-command'] }}
      test-command: ${{ steps.detect.outputs['test-command'] }}
      lint-command: ${{ steps.detect.outputs['lint-command'] }}
      format-command: ${{ steps.detect.outputs['format-command'] }}
      typecheck-command: ${{ steps.detect.outputs['typecheck-command'] }}
      install-command: ${{ steps.detect.outputs['install-command'] }}
      audit-command: ${{ steps.detect.outputs['audit-command'] }}
      license-check: ${{ steps.detect.outputs['license-check'] }}
      security-audit: ${{ steps.detect.outputs['security-audit'] }}
      audit-level: ${{ steps.detect.outputs['audit-level'] }}
      has-python: ${{ steps.detect.outputs['has-python'] }}
      has-go: ${{ steps.detect.outputs['has-go'] }}
      has-rust: ${{ steps.detect.outputs['has-rust'] }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Detect project configuration
        id: detect
        shell: bash
        run: |
          # === Package manager ===
          PM_OVERRIDE="${{ inputs['package-manager'] }}"
          if [ -n "$PM_OVERRIDE" ]; then
            PM="$PM_OVERRIDE"
            if [ "$PM" = "pnpm" ]; then
              INSTALL="pnpm install --frozen-lockfile"
            elif [ "$PM" = "yarn" ]; then
              INSTALL="yarn install --frozen-lockfile"
            else
              PM="npm"
              INSTALL="npm ci"
            fi
          elif [ -f "pnpm-lock.yaml" ]; then
            PM="pnpm"
            INSTALL="pnpm install --frozen-lockfile"
          elif [ -f "yarn.lock" ]; then
            PM="yarn"
            INSTALL="yarn install --frozen-lockfile"
          else
            PM="npm"
            INSTALL="npm ci"
          fi

          # === Monorepo ===
          IS_MONOREPO="false"
          if [ -f "turbo.json" ] || [ -f "pnpm-workspace.yaml" ]; then
            IS_MONOREPO="true"
          elif [ -f "package.json" ] && node -e "const p=require('./package.json'); process.exit(p.workspaces ? 0 : 1)" 2>/dev/null; then
            IS_MONOREPO="true"
          fi
          # Also check for lerna.json or nx.json
          if [ -f "lerna.json" ] || [ -f "nx.json" ]; then
            IS_MONOREPO="true"
          fi

          # === Package.json scripts ===
          HAS_SCRIPT_BUILD="false"
          HAS_SCRIPT_TEST="false"
          HAS_SCRIPT_LINT="false"
          HAS_SCRIPT_FORMAT="false"
          HAS_SCRIPT_TYPECHECK="false"
          if [ -f "package.json" ]; then
            HAS_SCRIPT_BUILD=$(node -e "const s=require('./package.json').scripts||{}; console.log(!!s.build)" 2>/dev/null || echo "false")
            HAS_SCRIPT_TEST=$(node -e "const s=require('./package.json').scripts||{}; console.log(!!s.test && !s.test.includes('no test specified'))" 2>/dev/null || echo "false")
            HAS_SCRIPT_LINT=$(node -e "const s=require('./package.json').scripts||{}; console.log(!!s.lint)" 2>/dev/null || echo "false")
            HAS_SCRIPT_FORMAT=$(node -e "const s=require('./package.json').scripts||{}; console.log(!!(s['format:check']||s.format))" 2>/dev/null || echo "false")
            HAS_SCRIPT_TYPECHECK=$(node -e "const s=require('./package.json').scripts||{}; console.log(!!(s.typecheck||s['type-check']))" 2>/dev/null || echo "false")
          fi

          # === TypeScript ===
          DET_TS="false"
          [ -f "tsconfig.json" ] && DET_TS="true"

          # === ESLint ===
          DET_ESLINT="false"
          for f in .eslintrc .eslintrc.js .eslintrc.json .eslintrc.yml .eslintrc.yaml \
                   eslint.config.js eslint.config.mjs eslint.config.cjs eslint.config.ts; do
            [ -f "$f" ] && DET_ESLINT="true" && break
          done
          if [ "$DET_ESLINT" = "false" ] && [ -f "package.json" ]; then
            node -e "process.exit(require('./package.json').eslintConfig ? 0 : 1)" 2>/dev/null && DET_ESLINT="true"
          fi

          # === Prettier ===
          DET_PRETTIER="false"
          for f in .prettierrc .prettierrc.js .prettierrc.json .prettierrc.yml .prettierrc.yaml \
                   .prettierrc.toml prettier.config.js prettier.config.mjs prettier.config.cjs; do
            [ -f "$f" ] && DET_PRETTIER="true" && break
          done
          if [ "$DET_PRETTIER" = "false" ] && [ -f "package.json" ]; then
            node -e "process.exit(require('./package.json').prettier ? 0 : 1)" 2>/dev/null && DET_PRETTIER="true"
          fi

          # === Size limit ===
          DET_SIZE="false"
          [ -f ".size-limit.json" ] && DET_SIZE="true"

          # === Node versions ===
          NODE_VERSIONS='["20","22"]'
          if [ -f ".nvmrc" ]; then
            NV=$(cat .nvmrc | tr -d 'v \n')
            NODE_VERSIONS="[\"${NV}\"]"
          elif [ -f ".node-version" ]; then
            NV=$(cat .node-version | tr -d 'v \n')
            NODE_VERSIONS="[\"${NV}\"]"
          fi

          # === Other languages ===
          HAS_PYTHON="false"; [ -f "pyproject.toml" ] && HAS_PYTHON="true"
          HAS_GO="false"; [ -f "go.mod" ] && HAS_GO="true"
          HAS_RUST="false"; [ -f "Cargo.toml" ] && HAS_RUST="true"

          # === Commands (turbo variants for monorepos) ===
          if [ "$IS_MONOREPO" = "true" ] && [ -f "turbo.json" ]; then
            PREFIX="turbo"
          elif [ "$PM" = "pnpm" ]; then
            PREFIX="pnpm run"
          elif [ "$PM" = "yarn" ]; then
            PREFIX="yarn"
          else
            PREFIX="npm run"
          fi

          if [ "$IS_MONOREPO" = "true" ] && [ -f "turbo.json" ]; then
            BUILD_CMD="turbo build"
            TEST_CMD="turbo test"
            LINT_CMD="turbo lint"
            FORMAT_CMD="turbo format:check"
            TC_CMD="turbo typecheck"
          else
            BUILD_CMD="${PREFIX} build"
            TEST_CMD="${PM} test"
            LINT_CMD="${PREFIX} lint"
            FORMAT_CMD="${PREFIX} format:check"
            TC_CMD="${PREFIX} typecheck"
          fi

          # === Apply overrides (input beats detection) ===
          resolve_bool() {
            local input="$1" detected="$2"
            if [ -n "$input" ]; then echo "$input"; else echo "$detected"; fi
          }
          resolve_str() {
            local input="$1" detected="$2"
            if [ -n "$input" ]; then echo "$input"; else echo "$detected"; fi
          }

          OUT_TS=$(resolve_bool "${{ inputs['has-typescript'] }}" "$DET_TS")
          OUT_ESLINT=$(resolve_bool "${{ inputs['has-eslint'] }}" "$DET_ESLINT")
          OUT_PRETTIER=$(resolve_bool "${{ inputs['has-prettier'] }}" "$DET_PRETTIER")
          OUT_BUILD=$(resolve_bool "${{ inputs['has-build'] }}" "$HAS_SCRIPT_BUILD")
          OUT_SIZE=$(resolve_bool "${{ inputs['bundle-size'] }}" "$DET_SIZE")
          OUT_LICENSE=$(resolve_bool "${{ inputs['license-check'] }}" "true")
          OUT_AUDIT=$(resolve_bool "${{ inputs['security-audit'] }}" "true")
          OUT_AUDIT_LVL=$(resolve_str "${{ inputs['audit-level'] }}" "critical")
          OUT_NODE=$(resolve_str "${{ inputs['node-versions'] }}" "$NODE_VERSIONS")
          OUT_BUILD_CMD=$(resolve_str "${{ inputs['build-command'] }}" "$BUILD_CMD")
          OUT_TEST_CMD=$(resolve_str "${{ inputs['test-command'] }}" "$TEST_CMD")
          OUT_INSTALL_CMD=$(resolve_str "${{ inputs['install-command'] }}" "$INSTALL")
          OUT_LINT_CMD=$(resolve_str "${{ inputs['lint-command'] }}" "$LINT_CMD")
          OUT_FORMAT_CMD=$(resolve_str "${{ inputs['format-command'] }}" "$FORMAT_CMD")
          OUT_TC_CMD=$(resolve_str "${{ inputs['typecheck-command'] }}" "$TC_CMD")
          if [ "$PM" = "pnpm" ]; then
            AUDIT_RUN="pnpm audit --audit-level=${OUT_AUDIT_LVL}"
          elif [ "$PM" = "yarn" ]; then
            AUDIT_RUN="yarn audit --level ${OUT_AUDIT_LVL}"
          else
            AUDIT_RUN="npm audit --audit-level=${OUT_AUDIT_LVL}"
          fi

          # === Write outputs ===
          {
            echo "node-versions=${OUT_NODE}"
            echo "has-typescript=${OUT_TS}"
            echo "has-eslint=${OUT_ESLINT}"
            echo "has-prettier=${OUT_PRETTIER}"
            echo "has-build=${OUT_BUILD}"
            echo "has-test=${HAS_SCRIPT_TEST}"
            echo "has-size-limit=${OUT_SIZE}"
            echo "is-monorepo=${IS_MONOREPO}"
            echo "package-manager=${PM}"
            echo "build-command=${OUT_BUILD_CMD}"
            echo "test-command=${OUT_TEST_CMD}"
            echo "lint-command=${OUT_LINT_CMD}"
            echo "format-command=${OUT_FORMAT_CMD}"
            echo "typecheck-command=${OUT_TC_CMD}"
            echo "install-command=${OUT_INSTALL_CMD}"
            echo "audit-command=${AUDIT_RUN}"
            echo "license-check=${OUT_LICENSE}"
            echo "security-audit=${OUT_AUDIT}"
            echo "audit-level=${OUT_AUDIT_LVL}"
            echo "has-python=${HAS_PYTHON}"
            echo "has-go=${HAS_GO}"
            echo "has-rust=${HAS_RUST}"
          } >> "$GITHUB_OUTPUT"

          # === Summary ===
          echo "## üîç Auto-Detection Results" >> "$GITHUB_STEP_SUMMARY"
          echo "| Setting | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Package manager | \`${PM}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Monorepo | ${IS_MONOREPO} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Node versions | \`${OUT_NODE}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| TypeScript | ${OUT_TS} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| ESLint | ${OUT_ESLINT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Prettier | ${OUT_PRETTIER} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build | ${OUT_BUILD} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tests | ${HAS_SCRIPT_TEST} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Size limit | ${OUT_SIZE} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Python | ${HAS_PYTHON} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Go | ${HAS_GO} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Rust | ${HAS_RUST} |" >> "$GITHUB_STEP_SUMMARY"

  install:
    name: Install dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: detect
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        if: ${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') != '' }}
        with:
          node-version: 22
          cache: ${{ needs.detect.outputs['package-manager'] }}
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        if: ${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') == '' }}
        with:
          node-version: 22

      - name: Enable corepack
        if: needs.detect.outputs['package-manager'] != 'npm'
        run: corepack enable

      - run: ${{ needs.detect.outputs['install-command'] }}

      - uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: node_modules
          key: node-modules-22-${{ github.sha }}-${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') }}

  policy:
    name: Policy check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: detect
    outputs:
      gate-codeql: ${{ steps.policy.outputs['gate-codeql'] }}
      gate-dependency-review: ${{ steps.policy.outputs['gate-dependency-review'] }}
      gate-sbom: ${{ steps.policy.outputs['gate-sbom'] }}
      gate-slsa-provenance: ${{ steps.policy.outputs['gate-slsa-provenance'] }}
      gate-ossf-scorecard: ${{ steps.policy.outputs['gate-ossf-scorecard'] }}
      pr-feedback-enabled: ${{ steps.policy.outputs['pr-feedback-enabled'] }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Validate .citemplate.yml
        id: policy
        shell: bash
        env:
          INPUT_GATE_CODEQL: ${{ inputs['gate-codeql'] }}
          INPUT_GATE_DEPENDENCY_REVIEW: ${{ inputs['gate-dependency-review'] }}
          INPUT_GATE_SBOM: ${{ inputs['gate-sbom'] }}
          INPUT_GATE_SLSA_PROVENANCE: ${{ inputs['gate-slsa-provenance'] }}
          INPUT_GATE_OSSF_SCORECARD: ${{ inputs['gate-ossf-scorecard'] }}
        run: |
          bool_or() {
            local a="$1"
            local b="$2"
            if [ "$a" = "true" ] || [ "$b" = "true" ]; then
              echo "true"
            else
              echo "false"
            fi
          }

          get_bool_value() {
            local key="$1"
            local out="false"
            if grep -Eq "^[[:space:]]*${key}:[[:space:]]*(true|false)[[:space:]]*$" .citemplate.yml; then
              out=$(grep -E "^[[:space:]]*${key}:[[:space:]]*(true|false)[[:space:]]*$" .citemplate.yml | head -n1 | awk -F':' '{print $2}' | xargs)
            fi
            echo "$out"
          }

          POLICY_GATE_CODEQL="false"
          POLICY_GATE_DEPENDENCY_REVIEW="false"
          POLICY_GATE_SBOM="false"
          POLICY_GATE_SLSA_PROVENANCE="false"
          POLICY_GATE_OSSF_SCORECARD="false"
          POLICY_PR_FEEDBACK_ENABLED="true"

          if [ ! -f ".citemplate.yml" ]; then
            echo "No .citemplate.yml found; skipping policy enforcement."
          else
            echo "Found .citemplate.yml; validating keys and values."

            if ! grep -q '^version:' .citemplate.yml; then
              echo "::error::Missing required key: version"
              exit 1
            fi
            if ! grep -q '^preset:' .citemplate.yml; then
              echo "::error::Missing required key: preset"
              exit 1
            fi

            # Unknown top-level keys are warnings in v1.x
            while IFS= read -r key; do
              case "$key" in
                version|preset|checks|pr_feedback|branches) ;;
                *) echo "::warning::Unknown top-level key in .citemplate.yml: $key" ;;
              esac
            done < <(grep -E '^[a-zA-Z_][a-zA-Z0-9_]*:' .citemplate.yml | cut -d: -f1)

            if grep -q 'audit_level:' .citemplate.yml; then
              LVL=$(grep -E 'audit_level:' .citemplate.yml | head -n1 | awk -F': ' '{print $2}' | tr -d '"' | tr -d "'" | xargs)
              case "$LVL" in
                critical|high|moderate|low) ;;
                *)
                  echo "::error::Invalid audit_level '$LVL'. Allowed: critical, high, moderate, low."
                  exit 1
                  ;;
              esac
            fi

            if grep -q '^branches:' .citemplate.yml && grep -q 'protected:' .citemplate.yml; then
              if ! grep -E 'protected:.*main|^- main$' .citemplate.yml >/dev/null; then
                echo "::warning::branches.protected does not include main."
              fi
            fi

            POLICY_GATE_CODEQL=$(get_bool_value codeql)
            POLICY_GATE_DEPENDENCY_REVIEW=$(get_bool_value dependency_review)
            POLICY_GATE_SBOM=$(get_bool_value sbom)
            POLICY_GATE_SLSA_PROVENANCE=$(get_bool_value slsa_provenance)
            POLICY_GATE_OSSF_SCORECARD=$(get_bool_value ossf_scorecard)
            if awk '/^pr_feedback:/{flag=1;next}/^[^[:space:]]/{flag=0}flag' .citemplate.yml | grep -Eq '^[[:space:]]*enabled:[[:space:]]*(true|false)[[:space:]]*$'; then
              POLICY_PR_FEEDBACK_ENABLED=$(awk '/^pr_feedback:/{flag=1;next}/^[^[:space:]]/{flag=0}flag' .citemplate.yml | grep -E '^[[:space:]]*enabled:[[:space:]]*(true|false)[[:space:]]*$' | head -n1 | awk -F':' '{print $2}' | xargs)
            fi

            echo "Policy validation complete."
          fi

          GATE_CODEQL=$(bool_or "$INPUT_GATE_CODEQL" "$POLICY_GATE_CODEQL")
          GATE_DEPENDENCY_REVIEW=$(bool_or "$INPUT_GATE_DEPENDENCY_REVIEW" "$POLICY_GATE_DEPENDENCY_REVIEW")
          GATE_SBOM=$(bool_or "$INPUT_GATE_SBOM" "$POLICY_GATE_SBOM")
          GATE_SLSA_PROVENANCE=$(bool_or "$INPUT_GATE_SLSA_PROVENANCE" "$POLICY_GATE_SLSA_PROVENANCE")
          GATE_OSSF_SCORECARD=$(bool_or "$INPUT_GATE_OSSF_SCORECARD" "$POLICY_GATE_OSSF_SCORECARD")

          {
            echo "gate-codeql=$GATE_CODEQL"
            echo "gate-dependency-review=$GATE_DEPENDENCY_REVIEW"
            echo "gate-sbom=$GATE_SBOM"
            echo "gate-slsa-provenance=$GATE_SLSA_PROVENANCE"
            echo "gate-ossf-scorecard=$GATE_OSSF_SCORECARD"
            echo "pr-feedback-enabled=$POLICY_PR_FEEDBACK_ENABLED"
          } >> "$GITHUB_OUTPUT"

          echo "## Policy Security Gate Decisions" >> "$GITHUB_STEP_SUMMARY"
          echo "| Gate | Enabled |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| CodeQL | $GATE_CODEQL |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Dependency review | $GATE_DEPENDENCY_REVIEW |" >> "$GITHUB_STEP_SUMMARY"
          echo "| SBOM | $GATE_SBOM |" >> "$GITHUB_STEP_SUMMARY"
          echo "| SLSA provenance | $GATE_SLSA_PROVENANCE |" >> "$GITHUB_STEP_SUMMARY"
          echo "| OSSF Scorecard | $GATE_OSSF_SCORECARD |" >> "$GITHUB_STEP_SUMMARY"
          echo "| PR feedback comment | $POLICY_PR_FEEDBACK_ENABLED |" >> "$GITHUB_STEP_SUMMARY"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect, install]
    if: needs.detect.outputs['has-eslint'] == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
      - name: Enable corepack
        if: needs.detect.outputs['package-manager'] != 'npm'
        run: corepack enable
      - uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: node_modules
          key: node-modules-22-${{ github.sha }}-${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') }}
      - name: Verify lint script exists
        run: node -e "const s=require('./package.json').scripts||{}; if(!s.lint){console.error('‚ùå No \"lint\" script found in package.json. Add one or set has-eslint to false.');process.exit(1)}"
      - run: ${{ needs.detect.outputs['lint-command'] }}

  format:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect, install]
    if: needs.detect.outputs['has-prettier'] == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
      - name: Enable corepack
        if: needs.detect.outputs['package-manager'] != 'npm'
        run: corepack enable
      - uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: node_modules
          key: node-modules-22-${{ github.sha }}-${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') }}
      - name: Verify format script exists
        run: node -e "const s=require('./package.json').scripts||{}; if(!s['format:check']&&!s.format){console.error('‚ùå No \"format:check\" or \"format\" script found in package.json. Add one or set has-prettier to false.');process.exit(1)}"
      - run: ${{ needs.detect.outputs['format-command'] }}

  typecheck:
    name: Type check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect, install]
    if: needs.detect.outputs['has-typescript'] == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
      - name: Enable corepack
        if: needs.detect.outputs['package-manager'] != 'npm'
        run: corepack enable
      - uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: node_modules
          key: node-modules-22-${{ github.sha }}-${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') }}
      - name: Verify typecheck script exists
        run: node -e "const s=require('./package.json').scripts||{}; if(!s.typecheck&&!s['type-check']){console.error('‚ùå No \"typecheck\" script found in package.json. Add one or set has-typescript to false.');process.exit(1)}"
      - run: ${{ needs.detect.outputs['typecheck-command'] }}

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect, install]
    if: needs.detect.outputs['has-build'] == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
      - name: Enable corepack
        if: needs.detect.outputs['package-manager'] != 'npm'
        run: corepack enable
      - uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: node_modules
          key: node-modules-22-${{ github.sha }}-${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') }}
      - run: ${{ needs.detect.outputs['build-command'] }}
      - uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: dist
          key: dist-${{ github.sha }}

  test:
    name: Tests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect, build]
    if: ${{ always() && needs.detect.outputs['has-test'] == 'true' && needs.detect.result == 'success' && (needs.build.result == 'success' || needs.build.result == 'skipped') }}
    strategy:
      matrix:
        node-version: ${{ fromJson(needs.detect.outputs['node-versions']) }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        if: ${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') != '' }}
        with:
          node-version: ${{ matrix.node-version }}
          cache: ${{ needs.detect.outputs['package-manager'] }}
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        if: ${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') == '' }}
        with:
          node-version: ${{ matrix.node-version }}
      - name: Enable corepack
        if: needs.detect.outputs['package-manager'] != 'npm'
        run: corepack enable
      - name: Install dependencies
        run: ${{ needs.detect.outputs['install-command'] }}
      - uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        if: needs.detect.outputs['has-build'] == 'true'
        with:
          path: dist
          key: dist-${{ github.sha }}
      - name: Verify test script exists
        run: node -e "const s=require('./package.json').scripts||{}; if(!s.test||s.test.includes('no test specified')){console.error('‚ùå No \"test\" script found in package.json.');process.exit(1)}"
      - run: ${{ needs.detect.outputs['test-command'] }}

  security-audit:
    name: Security audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect, install]
    if: needs.detect.outputs['security-audit'] == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
      - name: Enable corepack
        if: needs.detect.outputs['package-manager'] != 'npm'
        run: corepack enable
      - uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: node_modules
          key: node-modules-22-${{ github.sha }}-${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') }}
      - run: ${{ needs.detect.outputs['audit-command'] }}

  license-check:
    name: License check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect, install]
    if: needs.detect.outputs['license-check'] == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
      - name: Enable corepack
        if: needs.detect.outputs['package-manager'] != 'npm'
        run: corepack enable
      - uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: node_modules
          key: node-modules-22-${{ github.sha }}-${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') }}
      - run: npx license-checker --failOn "GPL-2.0;GPL-3.0;AGPL-3.0;LGPL-2.0;LGPL-2.1;LGPL-3.0;SSPL-1.0;EUPL-1.1;EUPL-1.2"

  bundle-size:
    name: Bundle size check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect, install, build]
    if: ${{ needs.detect.outputs['has-size-limit'] == 'true' && always() && needs.install.result == 'success' && needs.build.result == 'success' }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 22
      - name: Enable corepack
        if: needs.detect.outputs['package-manager'] != 'npm'
        run: corepack enable
      - uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: node_modules
          key: node-modules-22-${{ github.sha }}-${{ hashFiles('package-lock.json', 'pnpm-lock.yaml', 'yarn.lock') }}
      - uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4
        with:
          path: dist
          key: dist-${{ github.sha }}
      - run: npx size-limit

  pr-feedback:
    name: PR feedback
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [detect, policy, lint, format, typecheck, build, test, security-audit, license-check, bundle-size]
    if: ${{ always() && github.event_name == 'pull_request' && needs.policy.outputs['pr-feedback-enabled'] == 'true' }}
    steps:
      - name: Publish aggregated PR comment
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
          RES_POLICY: ${{ needs.policy.result }}
          RES_LINT: ${{ needs.lint.result }}
          RES_FORMAT: ${{ needs.format.result }}
          RES_TYPECHECK: ${{ needs.typecheck.result }}
          RES_BUILD: ${{ needs.build.result }}
          RES_TEST: ${{ needs.test.result }}
          RES_AUDIT: ${{ needs['security-audit'].result }}
          RES_LICENSE: ${{ needs['license-check'].result }}
          RES_BUNDLE: ${{ needs['bundle-size'].result }}
        shell: bash
        run: |
          MARKER="<!-- launchpad:aggregated-feedback -->"
          BODY=$(cat <<'EOF'
          <!-- launchpad:aggregated-feedback -->
          ## Solvely Launchpad Summary

          | Check | Result |
          |---|---|
          | Policy | __RES_POLICY__ |
          | Lint | __RES_LINT__ |
          | Format | __RES_FORMAT__ |
          | Typecheck | __RES_TYPECHECK__ |
          | Build | __RES_BUILD__ |
          | Tests | __RES_TEST__ |
          | Security audit | __RES_AUDIT__ |
          | License check | __RES_LICENSE__ |
          | Bundle size | __RES_BUNDLE__ |

          ### Deltas
          - Coverage delta: available when coverage workflow artifacts are present.
          - Bundle delta: size-limit output is shown in job logs and summaries.

          ### Flaky Test Hints
          - If tests fail intermittently, rerun failed jobs and compare stack traces.
          - Repeated timeout/network failures usually indicate flake rather than regression.
          EOF
          )

          BODY="${BODY/__RES_POLICY__/$RES_POLICY}"
          BODY="${BODY/__RES_LINT__/$RES_LINT}"
          BODY="${BODY/__RES_FORMAT__/$RES_FORMAT}"
          BODY="${BODY/__RES_TYPECHECK__/$RES_TYPECHECK}"
          BODY="${BODY/__RES_BUILD__/$RES_BUILD}"
          BODY="${BODY/__RES_TEST__/$RES_TEST}"
          BODY="${BODY/__RES_AUDIT__/$RES_AUDIT}"
          BODY="${BODY/__RES_LICENSE__/$RES_LICENSE}"
          BODY="${BODY/__RES_BUNDLE__/$RES_BUNDLE}"

          EXISTING_ID=$(gh api repos/$REPO/issues/$PR_NUMBER/comments --paginate \
            --jq ".[] | select(.body | contains(\"$MARKER\")) | .id" | head -n1 || true)

          if [ -n "$EXISTING_ID" ]; then
            gh api repos/$REPO/issues/comments/$EXISTING_ID -X PATCH -f body="$BODY" >/dev/null
          else
            gh api repos/$REPO/issues/$PR_NUMBER/comments -X POST -f body="$BODY" >/dev/null
          fi
