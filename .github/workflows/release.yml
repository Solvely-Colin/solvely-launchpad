# Reusable release workflow â€” called by consumer repos
# Usage: uses: Solvely-Colin/solvely-launchpad/.github/workflows/release.yml@v1

name: Release to npm

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version'
        type: string
        default: '22'
      package-manager:
        description: 'Package manager (npm, pnpm, yarn)'
        type: string
        default: 'npm'
      package-name:
        description: 'npm package name for smoke test'
        type: string
        required: true
      package-directory:
        description: 'Directory containing package.json to publish'
        type: string
        default: '.'
      smoke-test-command:
        description: 'Custom smoke test command (empty = default npx check)'
        type: string
        default: ''
      npm-publish:
        description: 'Publish to npm'
        type: boolean
        default: true
    secrets:
      npm_token:
        description: 'NPM_TOKEN for publishing'
        required: false

permissions: {}

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: ${{ inputs.npm-publish }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ inputs.package-manager }}
          registry-url: https://registry.npmjs.org

      - name: Enable corepack
        if: inputs.package-manager != 'npm'
        run: corepack enable

      - name: Install dependencies
        shell: bash
        run: |
          cd "${{ inputs.package-directory }}"
          if [ "${{ inputs.package-manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install --no-audit --no-fund
            fi
          fi

      - name: Build if script exists
        shell: bash
        run: |
          cd "${{ inputs.package-directory }}"
          HAS_BUILD=$(node -e "const s=require('./package.json').scripts||{}; console.log(!!s.build)")
          if [ "$HAS_BUILD" = "true" ]; then
            if [ "${{ inputs.package-manager }}" = "pnpm" ]; then
              pnpm run build
            elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
              yarn build
            else
              npm run build
            fi
          else
            echo "No build script found; skipping build step."
          fi

      - name: Publish package
        shell: bash
        run: |
          cd "${{ inputs.package-directory }}"
          npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.npm_token }}

  release-notes:
    name: Generate release notes
    needs: publish
    if: ${{ always() && (needs.publish.result == 'success' || needs.publish.result == 'skipped') }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Update release notes
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          generate_release_notes: true

  smoke-test:
    name: Post-publish smoke test
    needs: publish
    if: ${{ inputs.npm-publish }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: https://registry.npmjs.org

      - name: Wait for npm propagation and verify
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(node -e "console.log(require('./${{ inputs.package-directory }}/package.json').version)")
          else
            VERSION=$(echo "$VERSION" | sed 's/^v//')
          fi
          PACKAGE="${{ inputs.package-name }}"
          for i in $(seq 1 18); do
            npm view ${PACKAGE}@$VERSION version && break || sleep 10
          done

      - name: Smoke test
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(node -e "console.log(require('./${{ inputs.package-directory }}/package.json').version)")
          else
            VERSION=$(echo "$VERSION" | sed 's/^v//')
          fi
          PACKAGE="${{ inputs.package-name }}"
          CUSTOM_CMD="${{ inputs.smoke-test-command }}"
          if [ -n "$CUSTOM_CMD" ]; then
            eval "$CUSTOM_CMD"
          else
            npx -p ${PACKAGE}@$VERSION -c "echo '${PACKAGE}@${VERSION} installed successfully'"
          fi
