# Optional quality gates for security-conscious repositories.
name: Quality Gates

on:
  workflow_call:
    inputs:
      codeql:
        description: 'Enable CodeQL'
        type: boolean
        default: false
      dependency-review:
        description: 'Enable dependency review'
        type: boolean
        default: false
      sbom:
        description: 'Enable SBOM generation'
        type: boolean
        default: false
      slsa-provenance:
        description: 'Enable SLSA provenance'
        type: boolean
        default: false
      ossf-scorecard:
        description: 'Enable OSSF Scorecard'
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read
  id-token: write
  attestations: write

concurrency:
  group: quality-gates-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codeql:
    if: ${{ inputs.codeql }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@f5c2471be782132e47a6e6f9c725e56730d6e9a3 # v3
        with:
          languages: javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@f5c2471be782132e47a6e6f9c725e56730d6e9a3 # v3

      - name: Analyze
        uses: github/codeql-action/analyze@f5c2471be782132e47a6e6f9c725e56730d6e9a3 # v3

  dependency-review:
    if: ${{ inputs.dependency-review && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4

  sbom:
    if: ${{ inputs.sbom }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Generate SBOM
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # v0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: sbom
          path: sbom.spdx.json

  slsa-provenance:
    if: ${{ inputs.slsa-provenance }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      actions: read
      id-token: write
      attestations: write
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Create source bundle
        run: tar -czf source.tgz .

      - name: Attest build provenance
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-path: source.tgz

  ossf-scorecard:
    if: ${{ inputs.ossf-scorecard }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Run OSSF Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: scorecard-results.sarif
          results_format: sarif
          publish_results: false

      - name: Upload Scorecard SARIF
        uses: github/codeql-action/upload-sarif@f5c2471be782132e47a6e6f9c725e56730d6e9a3 # v3
        with:
          sarif_file: scorecard-results.sarif

      - name: Upload Scorecard artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: scorecard-results
          path: scorecard-results.sarif
